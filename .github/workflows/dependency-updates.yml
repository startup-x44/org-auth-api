name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Update Go dependencies
      run: |
        go get -u ./...
        go mod tidy

    - name: Run tests after update
      run: go test -v ./...

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: update dependencies

          - Updated Go module dependencies
          - Ran tests to ensure compatibility
        title: 'chore: update dependencies'
        body: |
          ## Dependency Updates

          This PR updates Go module dependencies to their latest versions.

          ### Changes
          - Updated all Go dependencies using `go get -u`
          - Ran `go mod tidy` to clean up the module file
          - All tests pass after the update

          ### Verification
          - ✅ Tests pass
          - ✅ No breaking changes detected
          - ✅ Module file is clean

          Please review the changes and ensure they don't introduce any regressions.
        branch: automated/dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated
        assignees: ${{ github.actor }}

  update-docker-base:
    name: Update Docker Base Images
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update Docker base images
      run: |
        # Update golang base image
        sed -i 's/FROM golang:.*-alpine/FROM golang:1.23-alpine/g' Dockerfile*

        # Update alpine base image in final stage
        sed -i 's/FROM alpine:.*/FROM alpine:3.19/g' Dockerfile*

    - name: Check for changes
      id: verify-docker-changed
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request for Docker updates
      if: steps.verify-docker-changed.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          chore: update Docker base images

          - Updated Go base image to latest version
          - Updated Alpine base image to latest stable version
        title: 'chore: update Docker base images'
        body: |
          ## Docker Base Image Updates

          This PR updates Docker base images to their latest versions.

          ### Changes
          - Updated Go base image to `golang:1.23-alpine`
          - Updated Alpine base image to `alpine:3.19`

          ### Security Benefits
          - Latest security patches included
          - Smaller attack surface with updated base images
          - Better performance and bug fixes

          Please review and test the Docker builds after these changes.
        branch: automated/docker-updates
        delete-branch: true
        labels: |
          docker
          dependencies
          automated
        assignees: ${{ github.actor }}