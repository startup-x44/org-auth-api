<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 Flow Test - Traditional Authorization Code</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f7fafc;
            padding: 40px 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #1a202c;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #718096;
            font-size: 14px;
        }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
            margin-left: 10px;
        }
        
        .code-block {
            background: #1a202c;
            color: #48bb78;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin-top: 12px;
        }
        
        .info-box {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .info-box h4 {
            color: #2c5282;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-box p {
            color: #2d3748;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 24px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 16px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h3 {
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .step-content p {
            color: #4a5568;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .url-preview {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            word-break: break-all;
            font-size: 12px;
            color: #4a5568;
            margin-top: 10px;
        }
        
        .token-display {
            background: #f7fafc;
            border: 2px solid #48bb78;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .token-display h4 {
            color: #2f855a;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .token-display pre {
            background: white;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê OAuth2 Authorization Code Flow Tester</h1>
            <p class="subtitle">Test the traditional OAuth2 flow with GET /oauth/authorize (shows form) ‚Üí POST /oauth/authorize (processes login)</p>
        </div>
        
        <div class="section">
            <h2>üìã How It Works</h2>
            
            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3>Configure OAuth2 Parameters</h3>
                    <p>Enter your OAuth2 client credentials and configure the authorization request below.</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3>Start Authorization</h3>
                    <p>Click "Start OAuth2 Flow" to redirect to GET /oauth/authorize - this shows the login/consent form.</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h3>Login & Consent</h3>
                    <p>Enter your credentials in the form. The system validates you belong to the organization that owns the OAuth2 client.</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <h3>Receive Authorization Code</h3>
                    <p>After successful login, you'll be redirected back with an authorization code in the URL.</p>
                </div>
            </div>
            
            <div class="step">
                <div class="step-number">5</div>
                <div class="step-content">
                    <h3>Exchange for Access Token</h3>
                    <p>Use the authorization code to get an access token from POST /oauth/token.</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>‚öôÔ∏è Configuration</h2>
            
            <div class="info-box">
                <h4>üí° Prerequisites</h4>
                <p>1. Create an OAuth2 client app in the admin panel<br>
                2. Note down the client_id and client_secret<br>
                3. Make sure you're a member of the organization that owns the client</p>
            </div>
            
            <form id="configForm">
                <div class="form-group">
                    <label for="client_id">Client ID</label>
                    <input type="text" id="client_id" placeholder="your_client_id" required>
                </div>
                
                <div class="form-group">
                    <label for="redirect_uri">Redirect URI</label>
                    <input type="text" id="redirect_uri" value="http://localhost:8080/callback" placeholder="http://localhost:8080/callback" required>
                    <small style="color: #718096; font-size: 12px;">This page will handle the callback</small>
                </div>
                
                <div class="form-group">
                    <label for="scope">Scopes (space-separated)</label>
                    <input type="text" id="scope" value="email profile" placeholder="email profile org.read">
                </div>
                
                <div class="form-group">
                    <label for="state">State (CSRF protection)</label>
                    <input type="text" id="state" readonly>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="startOAuthFlow()">
                    üöÄ Start OAuth2 Flow
                </button>
                <button type="button" class="btn btn-secondary" onclick="generateState()">
                    üîÑ Regenerate State
                </button>
            </form>
            
            <div id="authUrl" class="url-preview" style="display: none;">
                <strong>Authorization URL:</strong><br>
                <span id="authUrlText"></span>
            </div>
        </div>
        
        <div class="section" id="callbackSection" style="display: none;">
            <h2>‚úÖ Authorization Code Received</h2>
            
            <div class="token-display">
                <h4>Authorization Code:</h4>
                <pre id="authCode"></pre>
            </div>
            
            <div class="token-display" style="border-color: #4299e1;">
                <h4>State (verify matches):</h4>
                <pre id="returnedState"></pre>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 16px;">Exchange for Access Token</h3>
                
                <div class="form-group">
                    <label for="client_secret">Client Secret</label>
                    <input type="password" id="client_secret" placeholder="your_client_secret" required>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="exchangeToken()">
                    üîë Exchange for Token
                </button>
            </div>
            
            <div id="tokenResult" style="display: none; margin-top: 20px;">
                <div class="token-display" style="border-color: #48bb78;">
                    <h4>Access Token Response:</h4>
                    <pre id="tokenData"></pre>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üìñ API Endpoints</h2>
            <div class="code-block">
GET  /api/v1/oauth/authorize       - Show login/consent form
POST /api/v1/oauth/authorize       - Process form submission (authenticate user)
POST /api/v1/oauth/token           - Exchange authorization code for access token
            </div>
        </div>
    </div>
    
    <script>
        // Generate random state on page load
        window.addEventListener('DOMContentLoaded', () => {
            generateState();
            checkCallback();
        });
        
        // Generate PKCE code verifier and challenge
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }
        
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(hash));
        }
        
        function base64URLEncode(buffer) {
            const base64 = btoa(String.fromCharCode(...buffer));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }
        
        function generateState() {
            const state = base64URLEncode(crypto.getRandomValues(new Uint8Array(16)));
            document.getElementById('state').value = state;
        }
        
        async function startOAuthFlow() {
            const clientId = document.getElementById('client_id').value;
            const redirectUri = document.getElementById('redirect_uri').value;
            const scope = document.getElementById('scope').value;
            const state = document.getElementById('state').value;
            
            if (!clientId || !redirectUri) {
                alert('Please fill in Client ID and Redirect URI');
                return;
            }
            
            // Generate PKCE parameters
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store code_verifier in localStorage for token exchange
            localStorage.setItem('code_verifier', codeVerifier);
            localStorage.setItem('oauth_state', state);
            
            // Build authorization URL
            const params = new URLSearchParams({
                client_id: clientId,
                redirect_uri: redirectUri,
                response_type: 'code',
                scope: scope,
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            });
            
            const authUrl = `http://localhost:8080/api/v1/oauth/authorize?${params.toString()}`;
            
            // Show URL preview
            document.getElementById('authUrlText').textContent = authUrl;
            document.getElementById('authUrl').style.display = 'block';
            
            // Redirect to authorization endpoint
            setTimeout(() => {
                window.location.href = authUrl;
            }, 1000);
        }
        
        function checkCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            const error = params.get('error');
            
            if (error) {
                alert(`OAuth2 Error: ${error}\n${params.get('error_description')}`);
                return;
            }
            
            if (code) {
                // Show callback section
                document.getElementById('callbackSection').style.display = 'block';
                document.getElementById('authCode').textContent = code;
                document.getElementById('returnedState').textContent = state || 'N/A';
                
                // Verify state matches
                const savedState = localStorage.getItem('oauth_state');
                if (savedState !== state) {
                    alert('‚ö†Ô∏è State mismatch! Possible CSRF attack.');
                }
                
                // Scroll to callback section
                document.getElementById('callbackSection').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        async function exchangeToken() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const clientId = document.getElementById('client_id').value;
            const clientSecret = document.getElementById('client_secret').value;
            const redirectUri = document.getElementById('redirect_uri').value;
            const codeVerifier = localStorage.getItem('code_verifier');
            
            if (!clientSecret) {
                alert('Please enter Client Secret');
                return;
            }
            
            if (!codeVerifier) {
                alert('Code verifier not found. Please start the flow again.');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        client_id: clientId,
                        client_secret: clientSecret,
                        redirect_uri: redirectUri,
                        code_verifier: codeVerifier
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('tokenData').textContent = JSON.stringify(data, null, 2);
                    document.getElementById('tokenResult').style.display = 'block';
                    
                    // Clean up localStorage
                    localStorage.removeItem('code_verifier');
                    localStorage.removeItem('oauth_state');
                } else {
                    alert(`Token Exchange Failed:\n${data.error}\n${data.error_description}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
