# SLO Alerting Rules for Auth Service
# These rules define Service Level Objectives and their corresponding alerts

groups:
  - name: auth_service_slo
    rules:
      # Authentication Success Rate SLO: 99.9%
      - alert: AuthenticationSuccessRateLow
        expr: |
          (
            sum(rate(auth_authentication_attempts_total{result="success"}[5m])) /
            sum(rate(auth_authentication_attempts_total[5m]))
          ) < 0.999
        for: 2m
        labels:
          severity: critical
          slo: authentication_success_rate
        annotations:
          summary: "Authentication success rate below SLO"
          description: "Authentication success rate is {{ $value | humanizePercentage }}, below the 99.9% SLO"

      # Authentication Latency SLO: 95% < 500ms
      - alert: AuthenticationLatencyHigh
        expr: |
          (
            sum(rate(auth_authentication_attempts_total{result="success",latency_bucket="fast"}[5m])) /
            sum(rate(auth_authentication_attempts_total{result="success"}[5m]))
          ) < 0.95
        for: 2m
        labels:
          severity: warning
          slo: authentication_latency
        annotations:
          summary: "Authentication latency exceeds SLO"
          description: "Only {{ $value | humanizePercentage }} of authentications complete within 500ms (SLO: 95%)"

      # Session Creation Success Rate SLO: 99.95%
      - alert: SessionCreationSuccessRateLow
        expr: |
          (
            sum(rate(auth_session_creation_attempts_total{result="success"}[5m])) /
            sum(rate(auth_session_creation_attempts_total[5m]))
          ) < 0.9995
        for: 1m
        labels:
          severity: critical
          slo: session_creation_success_rate
        annotations:
          summary: "Session creation success rate below SLO"
          description: "Session creation success rate is {{ $value | humanizePercentage }}, below the 99.95% SLO"

      # Token Validation Success Rate SLO: 99.99%
      - alert: TokenValidationSuccessRateLow
        expr: |
          (
            sum(rate(auth_token_validation_attempts_total{result="success"}[5m])) /
            sum(rate(auth_token_validation_attempts_total[5m]))
          ) < 0.9999
        for: 1m
        labels:
          severity: critical
          slo: token_validation_success_rate
        annotations:
          summary: "Token validation success rate below SLO"
          description: "Token validation success rate is {{ $value | humanizePercentage }}, below the 99.99% SLO"

      # OAuth Flow Completion Rate SLO: 99.5%
      - alert: OAuthFlowCompletionRateLow
        expr: |
          (
            sum(rate(auth_oauth_flow_attempts_total{result="success"}[5m])) /
            sum(rate(auth_oauth_flow_attempts_total[5m]))
          ) < 0.995
        for: 2m
        labels:
          severity: warning
          slo: oauth_flow_completion_rate
        annotations:
          summary: "OAuth flow completion rate below SLO"
          description: "OAuth flow completion rate is {{ $value | humanizePercentage }}, below the 99.5% SLO"

      # Service Availability SLO: 99.9%
      - alert: ServiceUnavailable
        expr: auth_service_availability{component="api"} < 1
        for: 30s
        labels:
          severity: critical
          slo: service_availability
        annotations:
          summary: "Auth service is unavailable"
          description: "Auth service API component is reporting unavailable status"

      # Database Availability SLO: 99.9%
      - alert: DatabaseUnavailable
        expr: auth_database_availability < 1
        for: 1m
        labels:
          severity: critical
          slo: database_availability
        annotations:
          summary: "Database is unavailable"
          description: "Database {{ $labels.database }} is reporting unavailable status"

      # Permission Check Latency SLO: 99% < 50ms
      - alert: PermissionCheckLatencyHigh
        expr: |
          (
            sum(rate(auth_permission_check_attempts_total{result="success",latency_bucket="fast"}[5m])) /
            sum(rate(auth_permission_check_attempts_total{result="success"}[5m]))
          ) < 0.99
        for: 2m
        labels:
          severity: warning
          slo: permission_check_latency
        annotations:
          summary: "Permission check latency exceeds SLO"
          description: "Only {{ $value | humanizePercentage }} of permission checks complete within 50ms (SLO: 99%)"

      # Error Budget Burn Rate Alerts
      - alert: AuthenticationErrorBudgetBurnRateHigh
        expr: |
          (
            sum(rate(auth_authentication_attempts_total{result="failure"}[1h])) /
            sum(rate(auth_authentication_attempts_total[1h]))
          ) > (1 - 0.999) * 14.4  # 14.4x burn rate for 1 hour window
        for: 2m
        labels:
          severity: critical
          slo: authentication_error_budget
        annotations:
          summary: "Authentication error budget burn rate is very high"
          description: "At current failure rate, authentication SLO error budget will be exhausted in 6 hours"

      - alert: AuthenticationErrorBudgetBurnRateMedium
        expr: |
          (
            sum(rate(auth_authentication_attempts_total{result="failure"}[6h])) /
            sum(rate(auth_authentication_attempts_total[6h]))
          ) > (1 - 0.999) * 6  # 6x burn rate for 6 hour window
        for: 15m
        labels:
          severity: warning
          slo: authentication_error_budget
        annotations:
          summary: "Authentication error budget burn rate is high"
          description: "At current failure rate, authentication SLO error budget will be exhausted in 1 day"

      # Security SLO Alerts
      - alert: SuspiciousActivityRateHigh
        expr: sum(rate(auth_suspicious_activity_total[5m])) > 0.1
        for: 1m
        labels:
          severity: warning
          slo: security
        annotations:
          summary: "High rate of suspicious activity detected"
          description: "Suspicious activity rate is {{ $value }} events/second, indicating potential security threats"

      - alert: FailedLoginAttemptsHigh
        expr: sum(rate(auth_failed_login_attempts_total[5m])) > 2
        for: 2m
        labels:
          severity: warning
          slo: security
        annotations:
          summary: "High rate of failed login attempts"
          description: "Failed login attempts rate is {{ $value }} attempts/second, indicating potential attacks"

      # Business Volume SLO Alerts
      - alert: ConcurrentUsersCapacityHigh
        expr: auth_concurrent_users > 8000  # Assuming 10k capacity with 80% threshold
        for: 5m
        labels:
          severity: warning
          slo: capacity
        annotations:
          summary: "Concurrent users approaching capacity limits"
          description: "Current concurrent users: {{ $value }}, approaching system capacity"

      # Client/Server Error Rate SLOs
      - alert: ClientErrorRateHigh
        expr: sum(rate(auth_client_errors_total[5m])) > 0.5
        for: 2m
        labels:
          severity: warning
          slo: error_rate
        annotations:
          summary: "High client error rate detected"
          description: "Client error (4xx) rate is {{ $value }} errors/second"

      - alert: ServerErrorRateHigh
        expr: sum(rate(auth_server_errors_total[5m])) > 0.01
        for: 1m
        labels:
          severity: critical
          slo: error_rate
        annotations:
          summary: "High server error rate detected"
          description: "Server error (5xx) rate is {{ $value }} errors/second, indicating service issues"

  - name: auth_service_slo_recording_rules
    rules:
      # Recording rules for SLI calculations (for dashboards and long-term analysis)
      
      # Authentication SLIs
      - record: auth:authentication_success_rate:5m
        expr: |
          sum(rate(auth_authentication_attempts_total{result="success"}[5m])) /
          sum(rate(auth_authentication_attempts_total[5m]))

      - record: auth:authentication_latency_p95:5m
        expr: histogram_quantile(0.95, sum(rate(auth_authentication_duration_seconds_bucket[5m])) by (le))

      - record: auth:authentication_latency_p99:5m
        expr: histogram_quantile(0.99, sum(rate(auth_authentication_duration_seconds_bucket[5m])) by (le))

      # Session SLIs
      - record: auth:session_creation_success_rate:5m
        expr: |
          sum(rate(auth_session_creation_attempts_total{result="success"}[5m])) /
          sum(rate(auth_session_creation_attempts_total[5m]))

      # Token Validation SLIs
      - record: auth:token_validation_success_rate:5m
        expr: |
          sum(rate(auth_token_validation_attempts_total{result="success"}[5m])) /
          sum(rate(auth_token_validation_attempts_total[5m]))

      - record: auth:token_validation_latency_p95:5m
        expr: histogram_quantile(0.95, sum(rate(auth_token_validation_duration_seconds_bucket[5m])) by (le))

      # OAuth Flow SLIs
      - record: auth:oauth_flow_success_rate:5m
        expr: |
          sum(rate(auth_oauth_flow_attempts_total{result="success"}[5m])) /
          sum(rate(auth_oauth_flow_attempts_total[5m]))

      # Permission Check SLIs
      - record: auth:permission_check_success_rate:5m
        expr: |
          sum(rate(auth_permission_check_attempts_total{result="success"}[5m])) /
          sum(rate(auth_permission_check_attempts_total[5m]))

      - record: auth:permission_check_latency_p95:5m
        expr: histogram_quantile(0.95, sum(rate(auth_permission_check_duration_seconds_bucket[5m])) by (le))

      # Overall Service Health Score (composite SLI)
      - record: auth:service_health_score:5m
        expr: |
          (
            auth:authentication_success_rate:5m * 0.3 +
            auth:session_creation_success_rate:5m * 0.2 +
            auth:token_validation_success_rate:5m * 0.2 +
            auth:oauth_flow_success_rate:5m * 0.15 +
            auth:permission_check_success_rate:5m * 0.15
          )

      # Error Budget Remaining (30-day window)
      - record: auth:authentication_error_budget_remaining:30d
        expr: |
          1 - (
            sum(increase(auth_authentication_attempts_total{result="failure"}[30d])) /
            sum(increase(auth_authentication_attempts_total[30d]))
          ) / (1 - 0.999)  # 99.9% SLO